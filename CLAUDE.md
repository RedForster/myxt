# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a 2D tower defense game called "Immune Tower Defense" (免疫塔防) built with Phaser 3 and TypeScript. The game simulates the human immune system where players deploy immune cells as towers to defend against pathogens.

## Development Commands

### Common Commands
- `npm install` - Install project dependencies
- `npm run dev` - Launch development server on http://localhost:8080 (sends anonymous usage data)
- `npm run build` - Create production build in `dist/` folder (sends anonymous usage data)
- `npm run dev-nolog` - Development server without usage data
- `npm run build-nolog` - Production build without usage data

### Development Server
- Runs on port 8080 by default
- Supports hot-reloading for quick development workflow
- Game is accessible at http://localhost:8080

## Architecture Overview

### Game Architecture Pattern
The game uses a **hybrid approach** combining:
- **Phaser Scene System** for game state management
- **Entity-Component style classes** for game objects
- **Event-driven communication** between scenes and systems

### Core Scenes
1. **Boot Scene** (`src/game/scenes/Boot.ts`) - Initial game setup
2. **Preloader Scene** (`src/game/scenes/Preloader.ts`) - Asset loading
3. **Game Scene** (`src/game/scenes/GameScene.ts`) - Main game logic
4. **UI Scene** (`src/game/scenes/UIScene.ts`) - User interface and controls

### Game Object Architecture
- **Base Entity** (`src/game/entities/Entity.ts`) - Common entity functionality
- **Tower Classes** (`src/game/entities/Tower.ts`) - Immune cell defenders
- **Enemy Classes** (`src/game/entities/Enemy.ts`) - Pathogen attackers
- **Immune Organ** (`src/game/entities/ImmuneOrgan.ts`) - Player's base
- **Projectiles** (`src/game/entities/Projectile.ts`) - Attack projectiles

### Configuration System
- **Level Config** (`src/game/config/LevelConfig.ts`) - Wave patterns, timing, unlocks
- **Units Config** (`src/game/config/UnitsConfig.ts`) - Unit stats, costs, abilities

## Key Game Systems

### 1. Resource Management
- **Player Health**: Global health that decreases when enemies reach the right side
- **Resources**: Generated by immune organ over time, used to build/upgrade towers
- **Events**: `resourcesChanged`, `playerHealthChanged` for UI updates

### 2. Tower Defense Mechanics
- **Tower Placement**: Click to place towers in the game area (left 75% of screen)
- **Targeting System**: Towers auto-target enemies within range using slot-based system
- **Projectile System**: Object pooling for performance, different damage types

### 3. Wave System
- **Timed Spawns**: Enemies spawn based on configured wave intervals
- **Difficulty Scaling**: Spawn rates increase over time
- **Initial Enemies**: Pre-placed enemies at game start

### 4. AI & Targeting
- **Slot-based Targeting**: Each tower/enemy has limited target slots to prevent over-focus
- **Range-based Attacks**: Units only engage when targets are within range
- **Auto-targeting**: Towers automatically find and engage nearest valid targets

## Asset Management

### Asset Structure
- **Game Assets**: `assets/` folder for sprites and textures
- **Public Assets**: `public/assets/` for static files loaded at runtime
- **UI Assets**: `assets/UI/` for interface elements

### Loading Strategy
- **Bundled Assets**: Imported via ES modules for small assets
- **Static Assets**: Loaded via Phaser Loader from `public/assets/`

## Game Design Reference

### Core Gameplay Loop
1. **Resource Generation**: Immune organ generates resources over time
2. **Tower Deployment**: Spend resources to place immune cell towers
3. **Combat**: Towers auto-attack enemies, enemies attack towers/organ
4. **Survival**: Prevent player health from reaching zero for 120 seconds

### Unit Types
- **Towers**: Neutrophil, B-cell, T-cell, Macrophage (unlock over time)
- **Enemies**: Common Bacteria (currently implemented)
- **Immune Organ**: Upgradeable base structure

### Victory Conditions
- **Win**: Survive 120 seconds with health > 0
- **Lose**: Player health reaches 0

## Development Notes

### TypeScript Configuration
- **Target**: ES2020 with modern module resolution
- **Strict Mode**: Enabled with property initialization disabled
- **Bundler Mode**: Optimized for Vite bundling

### Vite Configuration
- **Development**: `vite/config.dev.mjs` - Hot reload, port 8080
- **Production**: `vite/config.prod.mjs` - Minified with Terser, Phaser chunking

### Performance Considerations
- **Object Pooling**: Used for projectiles to reduce GC pressure
- **Group Management**: Phaser groups for efficient entity management
- **Event System**: Decoupled communication between game systems

## Important Files

### Entry Points
- `index.html` - Main HTML container
- `src/main.ts` - Application bootstrap
- `src/game/main.ts` - Phaser game configuration

### Core Game Logic
- `src/game/scenes/GameScene.ts` - Main game loop and systems
- `src/game/entities/` - All game entity classes
- `src/game/config/` - Game balance and configuration

### Configuration
- `tsconfig.json` - TypeScript settings
- `package.json` - Project dependencies and scripts
- `vite/config.*.mjs` - Build configuration

## Testing & Debugging

### Console Logging
- Extensive debug logging is present in GameScene and entity classes
- Key game state is logged every 5 seconds during development
- Use browser dev tools to monitor game state and performance

### Common Debug Tasks
- Check tower targeting: Look for "GameScene spawnEnemy" and "Tower update" logs
- Monitor resource flow: Track "resourcesChanged" events
- Verify wave spawning: Check wave timer and enemy spawn logs